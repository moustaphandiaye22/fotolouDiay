<div class="produits-container">
  <div class="header">
    <h1>Mes Produits</h1>
    <div class="header-actions">
      <button mat-icon-button [matTooltip]="viewMode === 'grid' ? 'Vue liste' : 'Vue grille'" (click)="toggleViewMode()">
        <mat-icon>{{ viewMode === 'grid' ? 'view_list' : 'view_module' }}</mat-icon>
      </button>
      <button mat-raised-button color="primary" routerLink="/produits/create">
        <mat-icon>add</mat-icon>
        Ajouter un produit
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Rechercher mes produits</mat-label>
      <input matInput
             [(ngModel)]="searchQuery"
             (input)="onSearchInput($event)"
             placeholder="Titre, description, localisation...">
      <mat-icon matPrefix>search</mat-icon>
      <button matSuffix mat-icon-button *ngIf="searchQuery" (click)="clearSearch()">
        <mat-icon>clear</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <div *ngIf="isLoading" class="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement de vos produits...</p>
  </div>

  <div *ngIf="!isLoading && errorMessage" class="error-message">
    <mat-icon>error</mat-icon>
    {{ errorMessage }}
  </div>

  <div *ngIf="!isLoading && produits.length === 0" class="no-produits">
    <mat-icon class="large-icon">inventory_2</mat-icon>
    <h3>Aucun produit</h3>
    <p>Vous n'avez pas encore publié de produit.</p>
    <button mat-raised-button color="primary" routerLink="/produits/create">
      Publier mon premier produit
    </button>
  </div>

  <div *ngIf="!isLoading && filteredProduits.length > 0" [class]="viewMode === 'grid' ? 'produits-grid' : 'produits-list'">
    <mat-card *ngFor="let produit of filteredProduits" class="produit-card" [routerLink]="['/produits', produit.id]">
      <div class="product-image">
        <img [src]="produit.imageUrl || '/assets/placeholder.jpg'" [alt]="produit.titre">
        <div class="product-badges">
          <mat-chip *ngIf="produit.estVip" color="accent">
            <mat-icon>star</mat-icon> VIP
          </mat-chip>
          <mat-chip [color]="getStatutColor(produit.statut)">
            {{ getStatutLabel(produit.statut) }}
          </mat-chip>
        </div>
      </div>

      <mat-card-content>
        <mat-card-title>{{ produit.titre }}</mat-card-title>
        <p class="description">{{ produit.description }}</p>
        
        <div class="produit-details">
          <div class="price">
            <strong>{{ formatPrix(produit.prix) }}</strong>
          </div>
          <div class="info-row" *ngIf="produit.localisation">
            <mat-icon>location_on</mat-icon>
            <span>{{ produit.localisation }}</span>
          </div>
          <div class="info-row">
            <mat-icon>visibility</mat-icon>
            <span>{{ produit.vues || 0 }} vues</span>
          </div>
          <div class="info-row">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ produit.dateCreation | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <div class="action-buttons">
          <button mat-button color="primary" [routerLink]="['/produits', produit.id]" (click)="$event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
            Voir
          </button>
          <button mat-button color="accent" (click)="editProduct(produit); $event.stopPropagation()">
            <mat-icon>edit</mat-icon>
            Modifier
          </button>
          <button mat-button color="warn" (click)="deleteProduct(produit); $event.stopPropagation()">
            <mat-icon>delete</mat-icon>
            Supprimer
          </button>
        </div>
        <div class="contact-actions" *ngIf="viewMode === 'list'">
          <button mat-icon-button
                  *ngIf="produit.utilisateur?.telephone"
                  [matTooltip]="'Appeler ' + produit.utilisateur?.telephone"
                  (click)="callUser(produit.utilisateur?.telephone); $event.stopPropagation()">
            <mat-icon>phone</mat-icon>
          </button>
          <button mat-icon-button
                  *ngIf="produit.utilisateur?.telephone"
                  [matTooltip]="'WhatsApp ' + produit.utilisateur?.telephone"
                  (click)="whatsappUser(produit.utilisateur?.telephone, produit.titre); $event.stopPropagation()">
            <i class="fab fa-whatsapp" style="font-size: 18px; color: #25D366;"></i>
          </button>
          <button mat-icon-button
                  [matTooltip]="'Discuter avec le propriétaire'"
                  (click)="messageUser(produit); $event.stopPropagation()">
            <mat-icon>message</mat-icon>
          </button>
        </div>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Pagination -->
  <!-- No results message when search has no matches -->
  <div *ngIf="!isLoading && searchQuery && filteredProduits.length === 0" class="no-results">
    <mat-icon class="large-icon">search_off</mat-icon>
    <h3>Aucun résultat</h3>
    <p>Aucun produit ne correspond à votre recherche "{{ searchQuery }}".</p>
    <button mat-button (click)="clearSearch()">
      <mat-icon>clear</mat-icon>
      Effacer la recherche
    </button>
  </div>

  <div *ngIf="!isLoading && !errorMessage && totalPages > 1" class="pagination-container">
    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 20, 50]"
      [pageIndex]="currentPage - 1"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
