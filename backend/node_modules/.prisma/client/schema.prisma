// Schéma Prisma pour FotoLouJay
// Application mobile de vente en ligne

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Utilisateur {
  id               Int             @id @default(autoincrement())
  nom              String
  prenom           String?
  email            String          @unique
  telephone        String?
  motDePasse       String
  role             RoleUtilisateur @default(UTILISATEUR)
  estActif         Boolean         @default(true)
  dateCreation     DateTime        @default(now())
  dateModification DateTime        @updatedAt

  // Relations
  produits               Produit[]
  notifications          Notification[]
  vuesProduites          VueProduit[]
  paiements              Paiement[]
  contactMessagesVendeur ContactMessage[] @relation("VendeurContactMessages")

  @@map("utilisateurs")
}

model Produit {
  id               Int           @id @default(autoincrement())
  titre            String
  description      String
  prix             Float
  estVip           Boolean       @default(false)
  imageUrl         String
  imagePublicId    String? // Pour la gestion des images (Cloudinary/Firebase)
  vues             Int           @default(0)
  statut           StatutProduit @default(EN_ATTENTE)
  localisation     String?
  categorie        String? // Catégorie du produit (Téléphone, Ordinateur, etc.)
  dateCreation     DateTime      @default(now())
  dateModification DateTime      @updatedAt
  dateExpiration   DateTime // Calculée automatiquement (+7 jours)

  // Relations
  utilisateurId   Int
  utilisateur     Utilisateur      @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  vuesProduites   VueProduit[]
  paiements       Paiement[]
  contactMessages ContactMessage[]

  @@index([statut])
  @@index([estVip])
  @@index([dateExpiration])
  @@index([categorie])
  @@map("produits")
}

model Notification {
  id           Int              @id @default(autoincrement())
  titre        String
  message      String
  type         TypeNotification @default(GENERALE)
  estLue       Boolean          @default(false)
  dateCreation DateTime         @default(now())

  // Relations
  utilisateurId Int
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@index([utilisateurId, estLue])
  @@map("notifications")
}

model VueProduit {
  id        Int      @id @default(autoincrement())
  dateVue   DateTime @default(now())
  adresseIp String?

  // Relations
  produitId     Int
  produit       Produit      @relation(fields: [produitId], references: [id], onDelete: Cascade)
  utilisateurId Int? // Optionnel si l'utilisateur est connecté
  utilisateur   Utilisateur? @relation(fields: [utilisateurId], references: [id], onDelete: SetNull)

  @@unique([produitId, utilisateurId, adresseIp]) // Éviter les doublons de vues
  @@map("vues_produits")
}

model Paiement {
  id               Int                 @id @default(autoincrement())
  reference        String              @unique
  montant          Float
  prestataire      PrestatairePaiement
  statut           StatutPaiement      @default(EN_ATTENTE)
  dateExpiration   DateTime
  dateCreation     DateTime            @default(now())
  dateModification DateTime            @updatedAt
  metadata         Json?

  // Relations
  utilisateurId Int
  utilisateur   Utilisateur   @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  produitId     Int
  produit       Produit       @relation(fields: [produitId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([reference])
  @@index([statut])
  @@index([dateExpiration])
  @@map("paiements")
}

model Transaction {
  id               Int               @id @default(autoincrement())
  type             TypeTransaction
  montant          Float
  statut           StatutTransaction @default(EN_ATTENTE)
  referenceExterne String? // Référence du prestataire de paiement
  dateCreation     DateTime          @default(now())
  dateModification DateTime          @updatedAt
  details          Json? // Détails supplémentaires de la transaction

  // Relations
  paiementId Int
  paiement   Paiement @relation(fields: [paiementId], references: [id], onDelete: Cascade)

  @@index([paiementId])
  @@index([statut])
  @@map("transactions")
}

model ContactMessage {
  id               Int           @id @default(autoincrement())
  nom              String
  email            String
  telephone        String?
  sujet            String
  message          String
  produitId        Int? // Optionnel, si le message concerne un produit spécifique
  vendeurId        Int? // Optionnel, si c'est une réponse à un vendeur spécifique
  captcha          String? // Réponse du captcha
  statut           ContactStatus @default(EN_ATTENTE)
  dateCreation     DateTime      @default(now())
  dateModification DateTime      @updatedAt

  // Relations
  produit Produit?     @relation(fields: [produitId], references: [id], onDelete: SetNull)
  vendeur Utilisateur? @relation("VendeurContactMessages", fields: [vendeurId], references: [id], onDelete: SetNull)

  @@index([statut])
  @@index([dateCreation])
  @@map("contact_messages")
}

// Enums
enum RoleUtilisateur {
  UTILISATEUR
  VENDEUR
  MODERATEUR
  ADMINISTRATEUR

  @@map("role_utilisateur")
}

enum StatutProduit {
  EN_ATTENTE // En attente de validation par un modérateur
  VALIDE // Validé et visible pour tous
  REJETE // Rejeté par un modérateur
  EXPIRE // Expiré automatiquement après 7 jours

  @@map("statut_produit")
}

enum TypeNotification {
  GENERALE // Notification générale
  PRODUIT_EXPIRE // Produit va expirer
  PRODUIT_VALIDE // Produit validé par modérateur
  PRODUIT_REJETE // Produit rejeté par modérateur
  RAPPEL // Rappel pour republier

  @@map("type_notification")
}

enum PrestatairePaiement {
  WAVE
  ORANGE_MONEY
  PAYTECH
  CARTE

  @@map("prestataire_paiement")
}

enum StatutPaiement {
  EN_ATTENTE
  CONFIRME
  ANNULE
  ECHEC
  EXPIRE

  @@map("statut_paiement")
}

enum TypeTransaction {
  DEBIT
  CREDIT
  REMBOURSEMENT

  @@map("type_transaction")
}

enum StatutTransaction {
  EN_ATTENTE
  SUCCES
  ECHEC
  ANNULE

  @@map("statut_transaction")
}

enum ContactStatus {
  EN_ATTENTE
  TRAITE
  IGNORE

  @@map("contact_status")
}
